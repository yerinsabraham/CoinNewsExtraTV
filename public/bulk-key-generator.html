<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bulk Key Generator - FREE</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    h1 { color: #667eea; margin-bottom: 10px; }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    .stat-label { font-size: 12px; color: #666; text-transform: uppercase; }
    .stat-value { font-size: 28px; font-weight: bold; color: #333; }
    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
    }
    .btn:hover { background: #5568d3; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .progress {
      background: #f0f0f0;
      border-radius: 10px;
      height: 30px;
      overflow: hidden;
      margin: 15px 0;
      display: none;
    }
    .progress-bar {
      background: linear-gradient(90deg, #667eea, #764ba2);
      height: 100%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
      display: none;
    }
    .log-entry { margin: 3px 0; }
    .success { color: #00ff00; }
    .error { color: #ff4444; }
    .info { color: #4CAF50; }
    input {
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      width: 200px;
    }
    .controls { margin: 20px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üîë Bulk Key Generator</h1>
      <p style="color: #666; margin-bottom: 20px;">
        Generate Hedera key pairs (private/public keys) - <strong>100% FREE</strong><br>
        No blockchain transactions, no HBAR cost. Only pay when users activate accounts.
      </p>

      <div class="stats" id="stats">
        <div class="stat-box">
          <div class="stat-label">Keys Generated</div>
          <div class="stat-value" id="keysGenerated">--</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Accounts Activated</div>
          <div class="stat-value" id="accountsActivated">--</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total Keys</div>
          <div class="stat-value" id="totalKeys">--</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Old System</div>
          <div class="stat-value" id="oldAccounts">--</div>
        </div>
      </div>

      <button class="btn" onclick="loadStats()">üîÑ Refresh Stats</button>
      <button class="btn" onclick="verifyData()">üîç Verify All Data</button>

      <div class="controls">
        <h3 style="margin-bottom: 10px;">Generate New Keys</h3>
        <label>
          Batch Size:
          <input type="number" id="batchSize" value="1000" min="100" max="2000" step="100">
        </label>
        <button class="btn" onclick="generateKeys()" id="generateBtn">Generate Keys</button>
      </div>

      <div class="progress" id="progressBar">
        <div class="progress-bar" id="progressFill">0%</div>
      </div>

      <div class="log" id="logBox"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-functions.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBDBq4vl23Fwo2itwUwuDrmjVuEw_b3sUc",
      authDomain: "coinnewsextratv-9c75a.firebaseapp.com",
      projectId: "coinnewsextratv-9c75a",
      storageBucket: "coinnewsextratv-9c75a.firebasestorage.app",
      messagingSenderId: "660117654774",
      appId: "1:660117654774:web:1f39e4fc4f2e1f41b8ad1e"
    };

    const app = initializeApp(firebaseConfig);
    const functions = getFunctions(app);

    window.functions = functions;
  </script>

  <script>
    function addLog(message, type = 'info') {
      const logBox = document.getElementById('logBox');
      logBox.style.display = 'block';
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      logEntry.textContent = `[${timestamp}] ${message}`;
      logBox.appendChild(logEntry);
      logBox.scrollTop = logBox.scrollHeight;
    }

    async function loadStats() {
      addLog('Loading statistics...');
      try {
        const getKeyStats = window.httpsCallable(window.functions, 'getKeyStats');
        const result = await getKeyStats();
        
        if (result.data.success) {
          document.getElementById('keysGenerated').textContent = result.data.keysGenerated.toLocaleString();
          document.getElementById('accountsActivated').textContent = result.data.accountsActivated.toLocaleString();
          document.getElementById('totalKeys').textContent = result.data.totalKeys.toLocaleString();
          document.getElementById('oldAccounts').textContent = result.data.oldGeneratedAccounts.toLocaleString();
          addLog('‚úÖ Stats loaded successfully', 'success');
        }
      } catch (error) {
        addLog(`‚ùå Error loading stats: ${error.message}`, 'error');
      }
    }

    async function generateKeys() {
      const batchSize = parseInt(document.getElementById('batchSize').value);
      const generateBtn = document.getElementById('generateBtn');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');

      generateBtn.disabled = true;
      progressBar.style.display = 'block';

      addLog(`Starting generation of ${batchSize} key pairs...`, 'info');

      try {
        const bulkGenerateKeys = window.httpsCallable(window.functions, 'bulkGenerateKeys');
        
        // Get current total to determine start index
        const getKeyStats = window.httpsCallable(window.functions, 'getKeyStats');
        const statsResult = await getKeyStats();
        const startIndex = statsResult.data.totalKeys || 0;

        addLog(`Starting from index ${startIndex}...`, 'info');

        const startTime = Date.now();
        const result = await bulkGenerateKeys({
          batchSize: batchSize,
          startIndex: startIndex
        });

        if (result.data.success) {
          progressFill.style.width = '100%';
          progressFill.textContent = '100% Complete';
          
          addLog(`‚úÖ Generated ${result.data.generated} keys in ${result.data.duration}s`, 'success');
          addLog(`‚ö° Rate: ${result.data.rate}`, 'success');
          
          if (result.data.failed > 0) {
            addLog(`‚ö†Ô∏è Failed: ${result.data.failed}`, 'error');
          }

          // Refresh stats
          await loadStats();
        }

      } catch (error) {
        addLog(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        generateBtn.disabled = false;
        setTimeout(() => {
          progressBar.style.display = 'none';
          progressFill.style.width = '0%';
        }, 2000);
      }
    }

    async function verifyData() {
      addLog('üìä Verifying all Firestore data...', 'info');
      try {
        const verifyHederaData = window.httpsCallable(window.functions, 'verifyHederaData');
        const result = await verifyHederaData();
        
        if (result.data.success) {
          const data = result.data.data.collections;
          
          addLog('=== FIRESTORE VERIFICATION ===', 'success');
          addLog(`‚úÖ hedera_generated_accounts: ${data.hedera_generated_accounts.count} total`, 'success');
          
          if (data.hedera_generated_accounts.samples.length > 0) {
            addLog('   Sample accounts:', 'info');
            data.hedera_generated_accounts.samples.forEach((acc, idx) => {
              addLog(`   ${idx + 1}. ${acc.accountId} - ${acc.did}`, 'info');
            });
          }
          
          addLog(`‚úÖ hedera_key_pairs: ${data.hedera_key_pairs.count} total`, 'success');
          if (data.hedera_key_pairs.samples.length > 0) {
            addLog('   Sample key pairs:', 'info');
            data.hedera_key_pairs.samples.forEach((key, idx) => {
              addLog(`   ${idx + 1}. Index ${key.index} - Status: ${key.status}`, 'info');
            });
          }
          
          addLog(`‚úÖ admin_created_accounts: ${data.admin_created_accounts.count} total`, 'success');
          addLog('=== VERIFICATION COMPLETE ===', 'success');
        }
      } catch (error) {
        addLog(`‚ùå Verification error: ${error.message}`, 'error');
      }
    }

    // Load stats on page load
    loadStats();
  </script>
</body>
</html>
